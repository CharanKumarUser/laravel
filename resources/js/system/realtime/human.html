<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Android-Style Face Enrollment</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            background-color: #f0f0f0;
            font-family: Arial, sans-serif;
            color: #333;
        }
        #container {
            position: relative;
            width: 100%;
            max-width: 400px;
            text-align: center;
        }
        #video {
            width: 100%;
            border-radius: 10px;
        }
        #overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            pointer-events: none;
        }
        #circle {
            width: 200px;
            height: 200px;
            border: 2px solid #ccc;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
        }
        #progress {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            transform: rotate(-90deg);
        }
        #progress-circle {
            stroke: #4CAF50;
            stroke-width: 4;
            fill: none;
            stroke-dasharray: 628; /* Circumference of circle with r=100 */
            stroke-dashoffset: 628;
            transition: stroke-dashoffset 0.5s linear;
        }
        #instruction {
            margin-top: 20px;
            font-size: 18px;
            font-weight: bold;
        }
        #confirmation {
            display: none;
            font-size: 24px;
            color: #4CAF50;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/@vladmandic/human/dist/human.js"></script>
</head>
<body>
    <div id="container">
        <video id="video" autoplay playsinline muted></video>
        <div id="overlay">
            <div id="circle">
                <svg id="progress" viewBox="0 0 200 200">
                    <circle id="progress-circle" cx="100" cy="100" r="100" />
                </svg>
            </div>
            <div id="instruction">Starting enrollment...</div>
            <div id="confirmation">Enrollment complete!</div>
        </div>
    </div>
    <script>
        const config = { backend: 'webgl' };
        const human = new Human.Human(config); // Correct instantiation using Human.Human
        const video = document.getElementById('video');
        const instruction = document.getElementById('instruction');
        const confirmation = document.getElementById('confirmation');
        const overlay = document.getElementById('overlay');
        const progressCircle = document.getElementById('progress-circle');

        const steps = [
            'Look straight at the camera',
            'Turn your head left',
            'Turn your head right',
            'Look up',
            'Look down'
        ];
        let currentStep = 0;
        let embeddings = [];
        const totalSteps = steps.length;
        const circumference = 628; // For r=100

        async function startWebcam() {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            video.srcObject = stream;
            await human.load(); // Load Human models
            human.video(video); // Start video processing
            processNextStep();
        }

        function updateProgress() {
            const progress = (currentStep / totalSteps) * circumference;
            progressCircle.style.strokeDashoffset = circumference - progress;
        }

        async function processNextStep() {
            if (currentStep >= totalSteps) {
                overlay.style.display = 'none';
                confirmation.style.display = 'block';
                console.log('Captured embeddings:', embeddings); // For debugging
                return;
            }

            instruction.textContent = steps[currentStep];
            await detectAndCapture();
        }

        async function detectAndCapture() {
            const result = await human.detect(video);
            if (result.face.length > 0) {
                const face = result.face[0];
                // Check if face is roughly centered (simple heuristic: score > 0.5 and centered in frame)
                if (face.score > 0.5 && Math.abs(face.box[0] - video.videoWidth / 4) < 100 && Math.abs(face.box[1] - video.videoHeight / 4) < 100) {
                    embeddings.push(face.embedding); // Capture embedding
                    currentStep++;
                    updateProgress();
                    processNextStep();
                }
            }
            requestAnimationFrame(detectAndCapture);
        }

        startWebcam();
    </script>
</body>
</html>
